rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Allow querying by email to check if email exists (for signup validation)
      // This allows unauthenticated users to check email availability during signup
      allow list: if true; // Allow queries to check email existence
      
      // Users can read their own document
      allow get: if isOwner(userId);
      
      // Users can create their own document (during signup)
      // This works for both patients and doctors
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll(['uid', 'email', 'userType', 'createdAt'])
                    && request.resource.data.uid == userId
                    && request.resource.data.email == request.auth.token.email
                    && request.resource.data.userType is string
                    && (request.resource.data.userType == 'patient' || request.resource.data.userType == 'doctor' || request.resource.data.userType == 'admin');
      
      // Users can update their own document
      allow update: if isOwner(userId)
                    && request.resource.data.uid == userId
                    && request.resource.data.email == resource.data.email; // Email cannot be changed
      
      // Users cannot delete their own account (admins only, to be implemented later)
      allow delete: if false;
      
      // Doctors can read patient profiles (for consultations and appointments)
      // This rule only applies if the requesting user is a doctor
      allow get: if isAuthenticated() 
                  && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'doctor'
                  && resource.data.userType == 'patient';
      
      // Patients can read doctor profiles (for booking appointments)
      // This rule only applies if the requesting user is a patient
      allow get: if isAuthenticated() 
                  && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'patient'
                  && resource.data.userType == 'doctor';
    }
    
    // Appointments collection
    match /appointments/{appointmentId} {
      // Allow reading individual appointments if user is patient or doctor
      // Also allow streams (snapshots) for real-time updates
      allow read: if isAuthenticated() 
                  && (resource.data.patientId == request.auth.uid 
                      || resource.data.doctorId == request.auth.uid);
      
      // Allow querying appointments for availability checking
      // Patients can query by doctorId to check availability
      // Doctors can query their own appointments
      allow list: if isAuthenticated();
      
      // Allow creating appointments (patients only)
      allow create: if isAuthenticated() 
                   && request.resource.data.patientId == request.auth.uid
                   && request.resource.data.keys().hasAll(['id', 'patientId', 'doctorId', 'scheduledTime', 'type', 'status', 'createdAt']);
      
      // Allow updating appointments (patient or doctor can update their own)
      allow update: if isAuthenticated() 
                   && (resource.data.patientId == request.auth.uid 
                       || resource.data.doctorId == request.auth.uid);
      
      // Allow deleting appointments (patients can cancel)
      allow delete: if isAuthenticated() 
                   && resource.data.patientId == request.auth.uid;
      
      // Messages subcollection - chat messages for appointments
      match /messages/{messageId} {
        // Helper function to check if user is part of the appointment
        function isAppointmentParticipant() {
          return isAuthenticated() 
                 && (get(/databases/$(database)/documents/appointments/$(appointmentId)).data.patientId == request.auth.uid
                     || get(/databases/$(database)/documents/appointments/$(appointmentId)).data.doctorId == request.auth.uid);
        }
        
        // Allow reading messages if user is patient or doctor of the appointment
        allow read: if isAppointmentParticipant();
        
        // Allow creating messages if user is patient or doctor of the appointment
        allow create: if isAppointmentParticipant()
                     && request.resource.data.senderId == request.auth.uid
                     && request.resource.data.keys().hasAll(['id', 'appointmentId', 'senderId', 'senderName', 'message', 'timestamp', 'isRead']);
        
        // Allow updating messages (to mark as read) - can update messages from others
        allow update: if isAppointmentParticipant()
                     && resource.data.senderId != request.auth.uid
                     && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      }
    }
    
    // Prescriptions collection
    match /prescriptions/{prescriptionId} {
      // Patients and doctors can read prescriptions they're associated with
      allow read: if isAuthenticated() 
                  && (resource.data.patientId == request.auth.uid 
                      || resource.data.doctorId == request.auth.uid);
      
      // Allow querying prescriptions
      allow list: if isAuthenticated();
      
      // Only doctors can create prescriptions
      allow create: if isAuthenticated() 
                   && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                   && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'doctor'
                   && request.resource.data.doctorId == request.auth.uid
                   && request.resource.data.keys().hasAll(['id', 'patientId', 'doctorId', 'medications', 'prescribedDate', 'createdAt']);
      
      // Only doctors can update their own prescriptions
      allow update: if isAuthenticated() 
                   && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                   && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'doctor'
                   && resource.data.doctorId == request.auth.uid;
      
      // Prescriptions should not be deleted
      allow delete: if false;
    }
    
        // Medical reports collection
        match /medicalReports/{reportId} {
          // Patients can read their own reports
          // Doctors can read reports they've reviewed or are assigned to
          allow read: if isAuthenticated() 
                      && (resource.data.patientId == request.auth.uid 
                          || resource.data.reviewedBy == request.auth.uid
                          || resource.data.doctorId == request.auth.uid);
          
          // Allow querying reports
          allow list: if isAuthenticated();
          
          // Patients can create their own reports
          allow create: if isAuthenticated() 
                       && request.resource.data.patientId == request.auth.uid
                       && request.resource.data.keys().hasAll(['id', 'patientId', 'title', 'type', 'fileUrl', 'fileName', 'reportDate', 'uploadedAt']);
          
          // Patients can update their own reports
          // Doctors can update reports they're reviewing
          allow update: if isAuthenticated() 
                       && (resource.data.patientId == request.auth.uid
                           || (request.resource.data.reviewedBy == request.auth.uid
                               && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                               && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'doctor'));
          
          // Patients can delete their own reports
          allow delete: if isAuthenticated() 
                       && resource.data.patientId == request.auth.uid;
        }
        
        // Questionnaires collection
        match /questionnaires/{questionnaireId} {
          // Patients can read their own questionnaires
          allow read: if isAuthenticated() 
                      && resource.data.patientId == request.auth.uid;
          
          // Allow querying questionnaires
          allow list: if isAuthenticated();
          
          // Patients can create their own questionnaires
          allow create: if isAuthenticated() 
                       && request.resource.data.patientId == request.auth.uid
                       && request.resource.data.keys().hasAll(['id', 'patientId', 'symptoms', 'createdAt']);
          
          // Patients can update their own questionnaires
          allow update: if isAuthenticated() 
                       && resource.data.patientId == request.auth.uid;
          
          // Patients can delete their own questionnaires
          allow delete: if isAuthenticated() 
                       && resource.data.patientId == request.auth.uid;
        }
    
    // Payments collection
    match /payments/{paymentId} {
      // Patients can read their own payments
      allow read: if isAuthenticated() 
                  && (resource.data.patientId == request.auth.uid
                      || resource.data.doctorId == request.auth.uid);
      
      // Allow querying payments - patients can query their own, doctors can query theirs
      allow list: if isAuthenticated();
      
      // Patients can create payments for their appointments
      allow create: if isAuthenticated() 
                   && request.resource.data.patientId == request.auth.uid
                   && request.resource.data.keys().hasAll(['id', 'appointmentId', 'patientId', 'doctorId', 'amount', 'status', 'createdAt']);
      
      // Patients can update their own payments (for payment processing)
      // Doctors can also read payments for their appointments
      allow update: if isAuthenticated() 
                   && resource.data.patientId == request.auth.uid
                   && request.resource.data.patientId == resource.data.patientId
                   && request.resource.data.appointmentId == resource.data.appointmentId;
    }
    
    // Stethoscope recordings collection
    match /stethoscope/{recordingId} {
      // Patients can read their own recordings
      // Doctors can read recordings where they are the assigned doctor
      allow read: if isAuthenticated() 
                  && (resource.data.patientId == request.auth.uid
                      || resource.data.doctorId == request.auth.uid);
      
      // Allow querying - patients can query their own, doctors can query assigned ones
      allow list: if isAuthenticated();
      
      // Patients can create their own recordings
      allow create: if isAuthenticated() 
                   && request.resource.data.patientId == request.auth.uid
                   && request.resource.data.keys().hasAll(['id', 'patientId', 'audioUrl', 'fileName', 'recordedAt', 'durationSeconds']);
      
      // Patients can update their own recordings (notes, etc.)
      // Doctors can update doctorId and doctorNotes
      allow update: if isAuthenticated() 
                   && (resource.data.patientId == request.auth.uid
                       || (resource.data.doctorId == request.auth.uid && request.resource.data.doctorId == resource.data.doctorId));
      
      // Patients can delete their own recordings
      allow delete: if isAuthenticated() 
                   && resource.data.patientId == request.auth.uid;
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() 
                  && (resource.data.userId == request.auth.uid || !resource.exists);
      
      // Allow querying notifications
      allow list: if isAuthenticated();
      
      // Authenticated users can create notifications for any user (for sending notifications between users)
      // The userId field should be the recipient's ID
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasAll(['id', 'userId', 'type', 'title', 'body', 'createdAt'])
                    && request.resource.data.userId is string
                    && request.resource.data.type is string
                    && request.resource.data.title is string
                    && request.resource.data.body is string;
      
      // Users can update their own notifications (mark as read, delete)
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'updatedAt']);
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
    }
  }
}

